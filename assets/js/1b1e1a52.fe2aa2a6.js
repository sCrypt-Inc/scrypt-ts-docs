"use strict";(self.webpackChunkscrypt_docs=self.webpackChunkscrypt_docs||[]).push([[8e3],{3905:(e,t,n)=>{n.d(t,{Zo:()=>c,kt:()=>m});var r=n(7294);function a(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}function s(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(e);t&&(r=r.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,r)}return n}function i(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?s(Object(n),!0).forEach((function(t){a(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):s(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}function o(e,t){if(null==e)return{};var n,r,a=function(e,t){if(null==e)return{};var n,r,a={},s=Object.keys(e);for(r=0;r<s.length;r++)n=s[r],t.indexOf(n)>=0||(a[n]=e[n]);return a}(e,t);if(Object.getOwnPropertySymbols){var s=Object.getOwnPropertySymbols(e);for(r=0;r<s.length;r++)n=s[r],t.indexOf(n)>=0||Object.prototype.propertyIsEnumerable.call(e,n)&&(a[n]=e[n])}return a}var l=r.createContext({}),p=function(e){var t=r.useContext(l),n=t;return e&&(n="function"==typeof e?e(t):i(i({},t),e)),n},c=function(e){var t=p(e.components);return r.createElement(l.Provider,{value:t},e.children)},d={inlineCode:"code",wrapper:function(e){var t=e.children;return r.createElement(r.Fragment,{},t)}},u=r.forwardRef((function(e,t){var n=e.components,a=e.mdxType,s=e.originalType,l=e.parentName,c=o(e,["components","mdxType","originalType","parentName"]),u=p(n),m=a,y=u["".concat(l,".").concat(m)]||u[m]||d[m]||s;return n?r.createElement(y,i(i({ref:t},c),{},{components:n})):r.createElement(y,i({ref:t},c))}));function m(e,t){var n=arguments,a=t&&t.mdxType;if("string"==typeof e||a){var s=n.length,i=new Array(s);i[0]=u;var o={};for(var l in t)hasOwnProperty.call(t,l)&&(o[l]=t[l]);o.originalType=e,o.mdxType="string"==typeof e?e:a,i[1]=o;for(var p=2;p<s;p++)i[p]=n[p];return r.createElement.apply(null,i)}return r.createElement.apply(null,n)}u.displayName="MDXCreateElement"},1689:(e,t,n)=>{n.r(t),n.d(t,{assets:()=>l,contentTitle:()=>i,default:()=>d,frontMatter:()=>s,metadata:()=>o,toc:()=>p});var r=n(7462),a=(n(7294),n(3905));const s={sidebar_position:4},i="Use Script inside sCrypt",o={unversionedId:"advanced/inline-asm",id:"advanced/inline-asm",title:"Use Script inside sCrypt",description:"Script is a low-level language and acts as assembly for the Bitcoin Virtual Machine. Usually, developers do not have to deal with it directly and can use high-level languages like sCrypt. However, there are cases where using script is desirable. For example, customized script is optimized and thus smaller and more efficient than Script generated by sCrypt. Or script is generated using external tools like Baguette and needs to be integrated into sCrypt.",source:"@site/docs/advanced/inline-asm.md",sourceDirName:"advanced",slug:"/advanced/inline-asm",permalink:"/advanced/inline-asm",draft:!1,tags:[],version:"current",sidebarPosition:4,frontMatter:{sidebar_position:4},sidebar:"tutorialSidebar",previous:{title:"How to Debug ScriptContext Failure",permalink:"/advanced/how-to-debug-scriptcontext"},next:{title:"Use Code Separators",permalink:"/advanced/codeseparator"}},l={},p=[{value:"Set Inline Assembly Variables",id:"set-inline-assembly-variables",level:2}],c={toc:p};function d(e){let{components:t,...s}=e;return(0,a.kt)("wrapper",(0,r.Z)({},c,s,{components:t,mdxType:"MDXLayout"}),(0,a.kt)("h1",{id:"use-script-inside-scrypt"},"Use Script inside sCrypt"),(0,a.kt)("p",null,"Script is a low-level language and acts as assembly for the Bitcoin Virtual Machine. Usually, developers do not have to deal with it directly and can use high-level languages like sCrypt. However, there are cases where using script is desirable. For example, customized script is optimized and thus smaller and more efficient than Script generated by sCrypt. Or script is generated using external tools like ",(0,a.kt)("a",{parentName:"p",href:"https://replit-docs.frenchfrog42.repl.co"},"Baguette")," and needs to be integrated into sCrypt."),(0,a.kt)("p",null,"To achieve this currently, you have to edit the auto-generated ",(0,a.kt)("inlineCode",{parentName:"p"},".scrypt")," files under your project's ",(0,a.kt)("inlineCode",{parentName:"p"},"artifacts")," directory."),(0,a.kt)("p",null,"First you create a project called ",(0,a.kt)("inlineCode",{parentName:"p"},"P2PKH"),":"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-bash"},"npx scrypt-cli project P2PKH --asm\n")),(0,a.kt)("p",null,"Notice the ",(0,a.kt)("inlineCode",{parentName:"p"},"--asm")," option must be enabled, meaning you are going to use inline assembly format of script."),(0,a.kt)("p",null,"Your contract is at ",(0,a.kt)("inlineCode",{parentName:"p"},"src/contracts/p2pkh.ts"),":"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-ts"},"export class P2PKH extends SmartContract {\n    @prop()\n    readonly address: Addr\n\n    constructor(address: Addr) {\n        super(...arguments)\n        this.address = address\n    }\n\n    @method()\n    public unlock(sig: Sig, pubkey: PubKey) {\n        assert(\n            pubKey2Addr(pubkey) == this.address,\n            'public key does not correspond to address'\n        )\n        assert(this.checkSig(sig, pubkey), 'signature check failed')\n    }\n}\n")),(0,a.kt)("p",null,"Say you want to substitute the ",(0,a.kt)("inlineCode",{parentName:"p"},"unlock")," function with manual script, you edit the file ",(0,a.kt)("inlineCode",{parentName:"p"},".asm/asm.json"),"."),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-json"},'{\n  "P2PKH": {\n    "unlock": "OP_DUP OP_HASH160 $pubKeyHash OP_EQUALVERIFY OP_CHECKSIG"\n  }\n}\n')),(0,a.kt)("p",null,"Variables can be defined by prefix ",(0,a.kt)("inlineCode",{parentName:"p"},"$"),", as in ",(0,a.kt)("inlineCode",{parentName:"p"},"$pubKeyHash"),"."),(0,a.kt)("p",null,"We could also define multiple substitutions for multiple methods, if needed."),(0,a.kt)("p",null,"Now, you can compile the contracts with ",(0,a.kt)("inlineCode",{parentName:"p"},"--asm")," option:"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-sh"},"npx scrypt-cli compile --asm\n")),(0,a.kt)("p",null,"Now, after compiling, the function body will be replaced with script, as could be seen in ",(0,a.kt)("inlineCode",{parentName:"p"},"artifacts/P2PKH.scrypt"),"."),(0,a.kt)("p",null,(0,a.kt)("img",{src:n(7071).Z,width:"1178",height:"105"})),(0,a.kt)("h2",{id:"set-inline-assembly-variables"},"Set Inline Assembly Variables"),(0,a.kt)("p",null,"Assembly variables can be replaced with literal Script in ASM format using ",(0,a.kt)("inlineCode",{parentName:"p"},"setAsmVars()"),". Each variable is prefixed by its unique scope, namely, the contract and the function it is under."),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-ts"},"p2pkh = new P2PKH(Addr(myAddress.toByteString()))\n\n// Set ASM variable\n// Keep in mind that these are NOT constructor parameters and must be set separately.\nasmVarValues = {\n    'P2PKH.unlock.address': myAddress.toByteString()\n}\np2pkh.setAsmVars(asmVarValues)\n")),(0,a.kt)("p",null,"Full code can be found on ",(0,a.kt)("a",{parentName:"p",href:"https://github.com/sCrypt-Inc/boilerplate/blob/master/src/contracts/asmDemo.ts"},"GitHub"),".\nFor more information about inline script/assembly, please refer to ",(0,a.kt)("a",{parentName:"p",href:"https://scryptdoc.readthedocs.io/en/latest/asm.html"},"here"),"."),(0,a.kt)("admonition",{type:"note"},(0,a.kt)("p",{parentName:"admonition"},"Inline script bypasses many features of sCrypt such as type checking. Extreme caution has to be taken when using this advanced feature.")))}d.isMDXComponent=!0},7071:(e,t,n)=>{n.d(t,{Z:()=>r});const r=n.p+"assets/images/asm-84445835e3aed4df120b810f327067f4.png"}}]);