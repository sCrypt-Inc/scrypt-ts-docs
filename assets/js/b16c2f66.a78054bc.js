"use strict";(self.webpackChunkscrypt_docs=self.webpackChunkscrypt_docs||[]).push([[4346],{3905:(e,t,n)=>{n.d(t,{Zo:()=>p,kt:()=>h});var a=n(7294);function i(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}function o(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var a=Object.getOwnPropertySymbols(e);t&&(a=a.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,a)}return n}function r(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?o(Object(n),!0).forEach((function(t){i(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):o(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}function l(e,t){if(null==e)return{};var n,a,i=function(e,t){if(null==e)return{};var n,a,i={},o=Object.keys(e);for(a=0;a<o.length;a++)n=o[a],t.indexOf(n)>=0||(i[n]=e[n]);return i}(e,t);if(Object.getOwnPropertySymbols){var o=Object.getOwnPropertySymbols(e);for(a=0;a<o.length;a++)n=o[a],t.indexOf(n)>=0||Object.prototype.propertyIsEnumerable.call(e,n)&&(i[n]=e[n])}return i}var c=a.createContext({}),s=function(e){var t=a.useContext(c),n=t;return e&&(n="function"==typeof e?e(t):r(r({},t),e)),n},p=function(e){var t=s(e.components);return a.createElement(c.Provider,{value:t},e.children)},m={inlineCode:"code",wrapper:function(e){var t=e.children;return a.createElement(a.Fragment,{},t)}},d=a.forwardRef((function(e,t){var n=e.components,i=e.mdxType,o=e.originalType,c=e.parentName,p=l(e,["components","mdxType","originalType","parentName"]),d=s(n),h=i,u=d["".concat(c,".").concat(h)]||d[h]||m[h]||o;return n?a.createElement(u,r(r({ref:t},p),{},{components:n})):a.createElement(u,r({ref:t},p))}));function h(e,t){var n=arguments,i=t&&t.mdxType;if("string"==typeof e||i){var o=n.length,r=new Array(o);r[0]=d;var l={};for(var c in t)hasOwnProperty.call(t,c)&&(l[c]=t[c]);l.originalType=e,l.mdxType="string"==typeof e?e:i,r[1]=l;for(var s=2;s<o;s++)r[s]=n[s];return a.createElement.apply(null,r)}return a.createElement.apply(null,n)}d.displayName="MDXCreateElement"},4520:(e,t,n)=>{n.r(t),n.d(t,{assets:()=>c,contentTitle:()=>r,default:()=>m,frontMatter:()=>o,metadata:()=>l,toc:()=>s});var a=n(7462),i=(n(7294),n(3905));const o={sidebar_position:9},r="Time Lock",l={unversionedId:"advanced/timeLock",id:"advanced/timeLock",title:"Time Lock",description:"Overview",source:"@site/docs/advanced/timeLock.md",sourceDirName:"advanced",slug:"/advanced/timeLock",permalink:"/advanced/timeLock",draft:!1,tags:[],version:"current",sidebarPosition:9,frontMatter:{sidebar_position:9},sidebar:"tutorialSidebar",previous:{title:"Call Multiple Contracts in a Single Tx",permalink:"/advanced/how-to-call-multiple-contracts"},next:{title:"How to Sign P2PKH Inputs Using the Signer Class",permalink:"/advanced/How to only sign p2pkh inputs"}},c={},s=[{value:"Overview",id:"overview",level:2},{value:"What is a time lock?",id:"what-is-a-time-lock",level:3},{value:"Implementation",id:"implementation",level:3},{value:"Calling",id:"calling",level:4},{value:"How does it work?",id:"how-does-it-work",level:2}],p={toc:s};function m(e){let{components:t,...o}=e;return(0,i.kt)("wrapper",(0,a.Z)({},p,o,{components:t,mdxType:"MDXLayout"}),(0,i.kt)("h1",{id:"time-lock"},"Time Lock"),(0,i.kt)("h2",{id:"overview"},"Overview"),(0,i.kt)("p",null,"In this section, we will go over how to create a smart contract, which has a public method, that can only be unlocked once a certain point in time has passed."),(0,i.kt)("h3",{id:"what-is-a-time-lock"},"What is a time lock?"),(0,i.kt)("p",null,"In the context of smart contracts, a time-lock is a feature that restricts the spending of specific bitcoins until a specified future time or block height is reached. sCrypt offers capabilities to implement these types of time-locks in your smart contracts, providing a mechanism to ensure a transaction won't be included in a block before a certain point in time or block height is reached. In other words, the smart contract's method cannot be successfully invoked until that point in time has passed."),(0,i.kt)("p",null,"For instance, this mechanism could be used to add a withdrawal method to a smart contract. In the event of non-cooperation from other parties, an individual could retrieve their funds locked in the smart contract after some amount of time has passed. This approach is utilized in ",(0,i.kt)("a",{parentName:"p",href:"https://xiaohuiliu.medium.com/cross-chain-atomic-swaps-f13e874fcaa7"},"cross-chain atomic swaps"),", for example."),(0,i.kt)("p",null,(0,i.kt)("img",{src:n(4795).Z,width:"640",height:"320"}),"\n",(0,i.kt)("img",{src:n(3848).Z,width:"834",height:"418"}),"\n",(0,i.kt)("em",{parentName:"p"},"Image Credit: ",(0,i.kt)("a",{parentName:"em",href:"https://bcoin.io/guides/swaps.html"},"bcoin"))),(0,i.kt)("h3",{id:"implementation"},"Implementation"),(0,i.kt)("p",null,"In sCrypt, a time-lock can be enforced by constraining the ",(0,i.kt)("inlineCode",{parentName:"p"},"locktime")," and ",(0,i.kt)("inlineCode",{parentName:"p"},"sequence")," values of the ",(0,i.kt)("a",{parentName:"p",href:"../how-to-write-a-contract/scriptcontext"},"script execution context"),". This context pertains to the execution of the transaction, which includes a call to the smart contract's public method. Thus, if the value is constrained \u2013 for example, the ",(0,i.kt)("inlineCode",{parentName:"p"},"locktime")," needs to be above the value ",(0,i.kt)("inlineCode",{parentName:"p"},"1690236000")," (a Unix timestamp) \u2013 then this transaction cannot be included into the blockchain until that point in time."),(0,i.kt)("p",null,"Note that the value of ",(0,i.kt)("inlineCode",{parentName:"p"},"locktime")," can either be a Unix timestamp or a block height. For this value to be enforced, ",(0,i.kt)("inlineCode",{parentName:"p"},"sequence")," also needs to be set to a value less than ",(0,i.kt)("inlineCode",{parentName:"p"},"0xffffffff"),"."),(0,i.kt)("p",null,"sCrypt offers a convenient built-in function ",(0,i.kt)("inlineCode",{parentName:"p"},"timeLock")," to enforce this constraint."),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-ts"},"// Time after which our public method can be called.\n@prop()\nreadonly matureTime: bigint // Can be a timestamp or block height.\n\n// ...\n\n@method()\npublic unlock() {\n    // The following assertion ensures that the `unlock` method can\n    // not be successfully invoked until `matureTime` has passed.\n    assert(this.timeLock(this.matureTime), 'time lock not yet expired')\n}\n")),(0,i.kt)("p",null,"It is important to note that this mechanism can be employed solely to ensure that a method can be called ",(0,i.kt)("strong",{parentName:"p"},"after")," a specific point in time. In contrast, it cannot be employed to ensure that a method is called ",(0,i.kt)("strong",{parentName:"p"},"before")," a specific point in time. "),(0,i.kt)("h4",{id:"calling"},"Calling"),(0,i.kt)("p",null,"Upon a method call to the ",(0,i.kt)("inlineCode",{parentName:"p"},"unlock")," method defined above, we need to set the ",(0,i.kt)("inlineCode",{parentName:"p"},"locktime")," value of the transaction that will call the public method. We can do this by simply setting the ",(0,i.kt)("inlineCode",{parentName:"p"},"locktime")," paramater of ",(0,i.kt)("inlineCode",{parentName:"p"},"MethodCallOptions"),"."),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-ts"},"timeLock.methods.unlock(\n    {\n        lockTime: 1673523720\n    } as MethodCallOptions<TimeLock>\n)\n")),(0,i.kt)("p",null,"Internally this will also set the inputs ",(0,i.kt)("inlineCode",{parentName:"p"},"sequence")," to a value lower than ",(0,i.kt)("inlineCode",{parentName:"p"},"0xffffffff"),". We can also set this value explicitly."),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-ts"},"timeLock.methods.unlock(\n    {\n        lockTime: 1673523720,\n        sequence: 0\n    } as MethodCallOptions<TimeLock>\n)\n")),(0,i.kt)("p",null,"Lastly, if we are using a ",(0,i.kt)("a",{parentName:"p",href:"/how-to-deploy-and-call-a-contract/how-to-customize-a-contract-tx"},"custom transaction builder")," we need to set these values for the unsigned transaction that we are building there."),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-ts"},"instance.bindTxBuilder('unlock',\n  async (\n    current: TimeLock,\n    options: MethodCallOptions<TimeLock>\n  ) => {\n\n    // ...\n\n    if (options.lockTime) {\n      unsignedTx.setLockTime(options.lockTime)\n    }\n    unsignedTx.setInputSequence(0, 0)\n    \n    // ...\n  }\n)\n")),(0,i.kt)("h2",{id:"how-does-it-work"},"How does it work?"),(0,i.kt)("p",null,"Under the hood, the ",(0,i.kt)("inlineCode",{parentName:"p"},"timeLock")," function asserts that the ",(0,i.kt)("inlineCode",{parentName:"p"},"sequence")," value of our calling transaction is less than ",(0,i.kt)("inlineCode",{parentName:"p"},"UINT_MAX"),". This ensures that the Bitcoin network will enforce the ",(0,i.kt)("inlineCode",{parentName:"p"},"locktime")," value."),(0,i.kt)("p",null,"Next, it checks if our target time-lock value indicates a block height or a Unix timestamp. If it's using a block height, i.e. the time-lock value is less than 500,000,000, the method also ensures that the ",(0,i.kt)("inlineCode",{parentName:"p"},"locktime")," value of the calling transaction corresponds to a block height."),(0,i.kt)("p",null,"Lastly, the method verifies that the value of ",(0,i.kt)("inlineCode",{parentName:"p"},"locktime")," is greater than or equal to the time-lock we have passed as an argument."),(0,i.kt)("p",null,"For more information on how the ",(0,i.kt)("inlineCode",{parentName:"p"},"locktime")," and ",(0,i.kt)("inlineCode",{parentName:"p"},"sequence")," values work, please read the ",(0,i.kt)("a",{parentName:"p",href:"https://wiki.bitcoinsv.io/index.php/NLocktime_and_nSequence"},"BSV wiki page"),"."))}m.isMDXComponent=!0},4795:(e,t,n)=>{n.d(t,{Z:()=>a});const a=n.p+"assets/images/swap1-597f5664552aa55a2618d36c008f6e93.png"},3848:(e,t,n)=>{n.d(t,{Z:()=>a});const a=n.p+"assets/images/swap2-eb0d41670833d5dcc2aad196be3be44f.png"}}]);