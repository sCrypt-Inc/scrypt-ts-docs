"use strict";(self.webpackChunkscrypt_docs=self.webpackChunkscrypt_docs||[]).push([[9615],{3905:(t,e,n)=>{n.d(e,{Zo:()=>p,kt:()=>m});var a=n(7294);function r(t,e,n){return e in t?Object.defineProperty(t,e,{value:n,enumerable:!0,configurable:!0,writable:!0}):t[e]=n,t}function o(t,e){var n=Object.keys(t);if(Object.getOwnPropertySymbols){var a=Object.getOwnPropertySymbols(t);e&&(a=a.filter((function(e){return Object.getOwnPropertyDescriptor(t,e).enumerable}))),n.push.apply(n,a)}return n}function i(t){for(var e=1;e<arguments.length;e++){var n=null!=arguments[e]?arguments[e]:{};e%2?o(Object(n),!0).forEach((function(e){r(t,e,n[e])})):Object.getOwnPropertyDescriptors?Object.defineProperties(t,Object.getOwnPropertyDescriptors(n)):o(Object(n)).forEach((function(e){Object.defineProperty(t,e,Object.getOwnPropertyDescriptor(n,e))}))}return t}function l(t,e){if(null==t)return{};var n,a,r=function(t,e){if(null==t)return{};var n,a,r={},o=Object.keys(t);for(a=0;a<o.length;a++)n=o[a],e.indexOf(n)>=0||(r[n]=t[n]);return r}(t,e);if(Object.getOwnPropertySymbols){var o=Object.getOwnPropertySymbols(t);for(a=0;a<o.length;a++)n=o[a],e.indexOf(n)>=0||Object.prototype.propertyIsEnumerable.call(t,n)&&(r[n]=t[n])}return r}var c=a.createContext({}),s=function(t){var e=a.useContext(c),n=e;return t&&(n="function"==typeof t?t(e):i(i({},e),t)),n},p=function(t){var e=s(t.components);return a.createElement(c.Provider,{value:e},t.children)},u={inlineCode:"code",wrapper:function(t){var e=t.children;return a.createElement(a.Fragment,{},e)}},d=a.forwardRef((function(t,e){var n=t.components,r=t.mdxType,o=t.originalType,c=t.parentName,p=l(t,["components","mdxType","originalType","parentName"]),d=s(n),m=r,h=d["".concat(c,".").concat(m)]||d[m]||u[m]||o;return n?a.createElement(h,i(i({ref:e},p),{},{components:n})):a.createElement(h,i({ref:e},p))}));function m(t,e){var n=arguments,r=e&&e.mdxType;if("string"==typeof t||r){var o=n.length,i=new Array(o);i[0]=d;var l={};for(var c in e)hasOwnProperty.call(e,c)&&(l[c]=e[c]);l.originalType=t,l.mdxType="string"==typeof t?t:r,i[1]=l;for(var s=2;s<o;s++)i[s]=n[s];return a.createElement.apply(null,i)}return a.createElement.apply(null,n)}d.displayName="MDXCreateElement"},8589:(t,e,n)=>{n.r(e),n.d(e,{assets:()=>c,contentTitle:()=>i,default:()=>u,frontMatter:()=>o,metadata:()=>l,toc:()=>s});var a=n(7462),r=(n(7294),n(3905));const o={sidebar_position:2},i="How to Customize a Contract Tx",l={unversionedId:"how-to-deploy-and-call-a-contract/how-to-customize-a-contract-tx",id:"how-to-deploy-and-call-a-contract/how-to-customize-a-contract-tx",title:"How to Customize a Contract Tx",description:"Deployment Tx",source:"@site/docs/how-to-deploy-and-call-a-contract/how-to-customize-a-contract-tx.md",sourceDirName:"how-to-deploy-and-call-a-contract",slug:"/how-to-deploy-and-call-a-contract/how-to-customize-a-contract-tx",permalink:"/how-to-deploy-and-call-a-contract/how-to-customize-a-contract-tx",draft:!1,tags:[],version:"current",sidebarPosition:2,frontMatter:{sidebar_position:2},sidebar:"tutorialSidebar",previous:{title:"How to Deploy & Call a Contract",permalink:"/how-to-deploy-and-call-a-contract/"},next:{title:"Deploy Using CLI",permalink:"/how-to-deploy-and-call-a-contract/deploy-cli"}},c={},s=[{value:"Deployment Tx",id:"deployment-tx",level:2},{value:"Default",id:"default",level:3},{value:"Customize",id:"customize",level:3},{value:"Call Tx",id:"call-tx",level:2},{value:"Default",id:"default-1",level:3},{value:"Customize",id:"customize-1",level:3},{value:"Notes",id:"notes",level:2}],p={toc:s};function u(t){let{components:e,...n}=t;return(0,r.kt)("wrapper",(0,a.Z)({},p,n,{components:e,mdxType:"MDXLayout"}),(0,r.kt)("h1",{id:"how-to-customize-a-contract-tx"},"How to Customize a Contract Tx"),(0,r.kt)("h2",{id:"deployment-tx"},"Deployment Tx"),(0,r.kt)("h3",{id:"default"},"Default"),(0,r.kt)("p",null,"For contract deployment, the default tx builder creates a transaction with the following structure:"),(0,r.kt)("ul",null,(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("p",{parentName:"li"},"Inputs:"),(0,r.kt)("ul",{parentName:"li"},(0,r.kt)("li",{parentName:"ul"},"[0\u2026]",": One or more ",(0,r.kt)("a",{parentName:"li",href:"https://learnmeabitcoin.com/technical/p2pkh"},"P2PKH")," inputs for paying transaction fees."))),(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("p",{parentName:"li"},"Outputs:"),(0,r.kt)("ul",{parentName:"li"},(0,r.kt)("li",{parentName:"ul"},"[0]",": The output containing the contract."),(0,r.kt)("li",{parentName:"ul"},"[1]",": A P2PKH change output if needed.")))),(0,r.kt)("p",null,"Numbers in [] represent index, starting from 0."),(0,r.kt)("p",null,(0,r.kt)("img",{parentName:"p",src:"https://lucid.app/publicSegments/view/5242c7cb-d30d-4a92-826c-4d6290e2af04/image.png",alt:null})),(0,r.kt)("h3",{id:"customize"},"Customize"),(0,r.kt)("p",null,"You can customize a contract's deployment tx builder by overriding its ",(0,r.kt)("a",{parentName:"p",href:"../how-to-write-a-contract/built-ins#builddeploytransaction"},"buildDeployTransaction")," method. An example is shown below."),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-ts"},"class DemoContract extends SmartContract {\n  // ...\n\n  // customize the deployment tx by overriding `SmartContract.buildDeployTransaction` method\n  override async buildDeployTransaction(utxos: UTXO[], amount: number, \n    changeAddress?: bsv.Address | string): Promise<bsv.Transaction> {\n    \n    const deployTx = new bsv.Transaction()\n      // add p2pkh inputs for paying tx fees\n      .from(utxos)\n      // add contract output\n      .addOutput(new bsv.Transaction.Output({\n        script: this.lockingScript,\n        satoshis: amount,\n      }))\n      // add OP_RETURN output\n      .addData('Hello World')\n\n    if (changeAddress) {\n      deployTx.change(changeAddress);\n      if (this._provider) {\n        deployTx.feePerKb(await this.provider.getFeePerKb())\n      }\n    }\n\n    return deployTx;\n  }\n}\n")),(0,r.kt)("p",null,"You may visit the ",(0,r.kt)("a",{parentName:"p",href:"https://github.com/sCrypt-Inc/boilerplate/blob/f63c37038a03bc51267e816d9441969d3e1d2ece/src/contracts/auction.ts#L100-L127"},"full code")," for more details."),(0,r.kt)("h2",{id:"call-tx"},"Call Tx"),(0,r.kt)("h3",{id:"default-1"},"Default"),(0,r.kt)("p",null,"For contract calls, the default tx builder creates a transaction with the following structure:"),(0,r.kt)("ul",null,(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("p",{parentName:"li"},"Inputs"),(0,r.kt)("ul",{parentName:"li"},(0,r.kt)("li",{parentName:"ul"},"[0]",": The input that spends the contract UTXO."),(0,r.kt)("li",{parentName:"ul"},"[1\u2026]",": Zero or more P2PKH inputs for paying transaction fees."))),(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("p",{parentName:"li"},"Outputs"),(0,r.kt)("ul",{parentName:"li"},(0,r.kt)("li",{parentName:"ul"},"[0\u2026N-1]",": One or more outputs, each containing a new contract instance (UTXO) if the contract is ",(0,r.kt)("a",{parentName:"li",href:"../how-to-write-a-contract/stateful-contract"},"stateful"),"."),(0,r.kt)("li",{parentName:"ul"},"[N]",": A P2PKH change output if needed.")))),(0,r.kt)("p",null,(0,r.kt)("img",{parentName:"p",src:"https://lucid.app/publicSegments/view/9dfde0f0-7275-48da-9411-057e895b5fb3/image.png",alt:null})),(0,r.kt)("h3",{id:"customize-1"},"Customize"),(0,r.kt)("p",null,"You can customize a tx builder for a public ",(0,r.kt)("inlineCode",{parentName:"p"},"@method")," of your contract by calling ",(0,r.kt)("inlineCode",{parentName:"p"},"bindTxBuilder"),". The first parameter is the public method name, and the second parameter is the customized tx builder of type ",(0,r.kt)("a",{parentName:"p",href:"../reference/interfaces/MethodCallTxBuilder"},"MethodCallTxBuilder"),"."),(0,r.kt)("p",null,(0,r.kt)("inlineCode",{parentName:"p"},"MethodCallTxBuilder")," takes three parameters:"),(0,r.kt)("ol",null,(0,r.kt)("li",{parentName:"ol"},(0,r.kt)("inlineCode",{parentName:"li"},"current: T"),": the actual instance of the smart contract T."),(0,r.kt)("li",{parentName:"ol"},(0,r.kt)("inlineCode",{parentName:"li"},"options"),": of type ",(0,r.kt)("a",{parentName:"li",href:"/how-to-deploy-and-call-a-contract/#methodcalloptions"},(0,r.kt)("inlineCode",{parentName:"a"},"MethodCallOptions<T>")),"."),(0,r.kt)("li",{parentName:"ol"},(0,r.kt)("inlineCode",{parentName:"li"},"...args: any"),": the same list of arguments as the bound pubic ",(0,r.kt)("inlineCode",{parentName:"li"},"@method"),".")),(0,r.kt)("p",null,"Take tx builder for our ",(0,r.kt)("a",{parentName:"p",href:"https://github.com/sCrypt-Inc/boilerplate/blob/master/src/contracts/auction.ts"},"auction smart contract")," as an example:"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-ts"},"// bind a customized tx builder for the public method `Auction.bid`\nauction.bindTxBuilder('bid', Auction.bidTxBuilder)\n\nstatic bidTxBuilder(\n    current: Auction,\n    options: MethodCallOptions<Auction>,\n    bidder: PubKey,\n    bid: bigint\n): Promise<ContractTransaction> {\n    const nextInstance = current.next()\n    nextInstance.bidder = bidder\n\n    const unsignedTx: Transaction = new Transaction()\n        // add contract input\n        .addInput(current.buildContractInput(options.fromUTXO))\n        // build next instance output\n        .addOutput(\n            new Transaction.Output({\n                script: nextInstance.lockingScript,\n                satoshis: Number(bid),\n            })\n        )\n        // build refund output\n        .addOutput(\n            new Transaction.Output({\n                script: Script.fromHex(\n                    Utils.buildPublicKeyHashScript(hash160(current.bidder))\n                ),\n                satoshis: current.balance,\n            })\n        )\n        // build change output\n        .change(options.changeAddress)\n\n    return Promise.resolve({\n        tx: unsignedTx,\n        atInputIndex: 0,\n        nexts: [\n            {\n                instance: nextInstance,\n                atOutputIndex: 0,\n                balance: Number(bid),\n            },\n        ],\n    })\n}\n")),(0,r.kt)("admonition",{type:"note"},(0,r.kt)("p",{parentName:"admonition"},"If the static function ",(0,r.kt)("inlineCode",{parentName:"p"},"bidTxBuilder")," is renamed by convention to ",(0,r.kt)("inlineCode",{parentName:"p"},"buildTxForBid"),", there is no need to explicitly call ",(0,r.kt)("inlineCode",{parentName:"p"},"auction.bindTxBuilder('bid', Auction.bidTxBuilder)"),"."),(0,r.kt)("p",{parentName:"admonition"},"The agreed rule is: ",(0,r.kt)("inlineCode",{parentName:"p"},"buildTxFor${camelCaseCapitalized(methodName)}"),". ",(0,r.kt)("inlineCode",{parentName:"p"},"camelCaseCapitalized()")," capitalizes the first letter of ",(0,r.kt)("inlineCode",{parentName:"p"},"methodName"),".")),(0,r.kt)("p",null,"In this example, we customize the calling transaction for the publid ",(0,r.kt)("inlineCode",{parentName:"p"},"@method")," ",(0,r.kt)("inlineCode",{parentName:"p"},"bid"),". ",(0,r.kt)("inlineCode",{parentName:"p"},"...args")," resolves to its parameters: ",(0,r.kt)("inlineCode",{parentName:"p"},"bidder: PubKey")," and ",(0,r.kt)("inlineCode",{parentName:"p"},"bid: bigint"),". The first input is the one that will reference the UTXO, where our smart contract instance currently resides. We use the ",(0,r.kt)("inlineCode",{parentName:"p"},"buildContractInput")," function to to build the input. Note that during the execution of the tx builder function, this input's script is empty. The script will get populated by the method arguments at a later stage of the method call."),(0,r.kt)("p",null,"The tx builder will return an object:"),(0,r.kt)("ul",null,(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("inlineCode",{parentName:"li"},"tx"),": the unsigned transaction of our method call."),(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("inlineCode",{parentName:"li"},"atInputIndex"),": the index of the input which will reference the smart contract UTXO."),(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("inlineCode",{parentName:"li"},"nexts"),": an array of objects that represent the contract's next instance(s). ")),(0,r.kt)("p",null,"When we are calling a ",(0,r.kt)("a",{parentName:"p",href:"/how-to-write-a-contract/stateful-contract"},"stateful smart contract"),", we have to define the next instance of our contract. This instance will contain updated states. As we can see, first a new instance is created using the current instance's ",(0,r.kt)("inlineCode",{parentName:"p"},"next()")," function. The new instance's ",(0,r.kt)("inlineCode",{parentName:"p"},"bidder")," property is then updated. This new instance is then included in the 0-th output of the new transaction and goes into the ",(0,r.kt)("inlineCode",{parentName:"p"},"nexts")," array of the returned object."),(0,r.kt)("h2",{id:"notes"},"Notes"),(0,r.kt)("p",null,"Please be aware that each of these tx builders should only create an ",(0,r.kt)("strong",{parentName:"p"},"unsigned")," transaction. If required, the transaction gets signed automatically in a later step prior to broadcasting."),(0,r.kt)("p",null,"Also, your customized tx must satisfy all of the called ",(0,r.kt)("inlineCode",{parentName:"p"},"@method"),"'s assertions."))}u.isMDXComponent=!0}}]);