"use strict";(self.webpackChunkscrypt_docs=self.webpackChunkscrypt_docs||[]).push([[1636],{3905:(t,e,n)=>{n.d(e,{Zo:()=>u,kt:()=>f});var a=n(7294);function o(t,e,n){return e in t?Object.defineProperty(t,e,{value:n,enumerable:!0,configurable:!0,writable:!0}):t[e]=n,t}function r(t,e){var n=Object.keys(t);if(Object.getOwnPropertySymbols){var a=Object.getOwnPropertySymbols(t);e&&(a=a.filter((function(e){return Object.getOwnPropertyDescriptor(t,e).enumerable}))),n.push.apply(n,a)}return n}function c(t){for(var e=1;e<arguments.length;e++){var n=null!=arguments[e]?arguments[e]:{};e%2?r(Object(n),!0).forEach((function(e){o(t,e,n[e])})):Object.getOwnPropertyDescriptors?Object.defineProperties(t,Object.getOwnPropertyDescriptors(n)):r(Object(n)).forEach((function(e){Object.defineProperty(t,e,Object.getOwnPropertyDescriptor(n,e))}))}return t}function l(t,e){if(null==t)return{};var n,a,o=function(t,e){if(null==t)return{};var n,a,o={},r=Object.keys(t);for(a=0;a<r.length;a++)n=r[a],e.indexOf(n)>=0||(o[n]=t[n]);return o}(t,e);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(t);for(a=0;a<r.length;a++)n=r[a],e.indexOf(n)>=0||Object.prototype.propertyIsEnumerable.call(t,n)&&(o[n]=t[n])}return o}var i=a.createContext({}),s=function(t){var e=a.useContext(i),n=e;return t&&(n="function"==typeof t?t(e):c(c({},e),t)),n},u=function(t){var e=s(t.components);return a.createElement(i.Provider,{value:e},t.children)},d={inlineCode:"code",wrapper:function(t){var e=t.children;return a.createElement(a.Fragment,{},e)}},p=a.forwardRef((function(t,e){var n=t.components,o=t.mdxType,r=t.originalType,i=t.parentName,u=l(t,["components","mdxType","originalType","parentName"]),p=s(n),f=o,h=p["".concat(i,".").concat(f)]||p[f]||d[f]||r;return n?a.createElement(h,c(c({ref:e},u),{},{components:n})):a.createElement(h,c({ref:e},u))}));function f(t,e){var n=arguments,o=e&&e.mdxType;if("string"==typeof t||o){var r=n.length,c=new Array(r);c[0]=p;var l={};for(var i in e)hasOwnProperty.call(e,i)&&(l[i]=e[i]);l.originalType=t,l.mdxType="string"==typeof t?t:o,c[1]=l;for(var s=2;s<r;s++)c[s]=n[s];return a.createElement.apply(null,c)}return a.createElement.apply(null,n)}p.displayName="MDXCreateElement"},7954:(t,e,n)=>{n.r(e),n.d(e,{assets:()=>i,contentTitle:()=>c,default:()=>d,frontMatter:()=>r,metadata:()=>l,toc:()=>s});var a=n(7462),o=(n(7294),n(3905));const r={sidebar_position:5},c="Interact with a Deployed Contract",l={unversionedId:"how-to-deploy-and-call-a-contract/call-deployed",id:"how-to-deploy-and-call-a-contract/call-deployed",title:"Interact with a Deployed Contract",description:"Overview",source:"@site/docs/how-to-deploy-and-call-a-contract/call-deployed.md",sourceDirName:"how-to-deploy-and-call-a-contract",slug:"/how-to-deploy-and-call-a-contract/call-deployed",permalink:"/how-to-deploy-and-call-a-contract/call-deployed",draft:!1,tags:[],version:"current",sidebarPosition:5,frontMatter:{sidebar_position:5},sidebar:"tutorialSidebar",previous:{title:"Faucet",permalink:"/how-to-deploy-and-call-a-contract/faucet"},next:{title:"How to Test a Contract",permalink:"/how-to-test-a-contract"}},i={},s=[{value:"Overview",id:"overview",level:2},{value:"The Smart Contract",id:"the-smart-contract",level:2},{value:"Deploy",id:"deploy",level:2},{value:"Interact",id:"interact",level:2},{value:"Conclusion",id:"conclusion",level:2}],u={toc:s};function d(t){let{components:e,...n}=t;return(0,o.kt)("wrapper",(0,a.Z)({},u,n,{components:e,mdxType:"MDXLayout"}),(0,o.kt)("h1",{id:"interact-with-a-deployed-contract"},"Interact with a Deployed Contract"),(0,o.kt)("h2",{id:"overview"},"Overview"),(0,o.kt)("p",null,"In this tutorial, we will interact with a deployed smart contract by calling its public method, in a separate process or by a different party.\nWe need to create an instance corresponding to the deployed contract on chain."),(0,o.kt)("h2",{id:"the-smart-contract"},"The Smart Contract"),(0,o.kt)("p",null,"We will reuse ",(0,o.kt)("a",{parentName:"p",href:"/how-to-write-a-contract/stateful-contract#create-a-stateful-contract"},"the ",(0,o.kt)("inlineCode",{parentName:"a"},"Counter")," contract"),"."),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-ts"},"export class Counter extends SmartContract {\n\n    @prop(true)\n    count: bigint\n\n    constructor(count: bigint) {\n        super(...arguments)\n        this.count = count\n    }\n\n    @method()\n    public increment() {\n        // Increment counter.\n        this.count++\n\n        // Ensure next output will contain this contracts code w\n        // the updated count property.\n        const amount: bigint = this.ctx.utxo.value\n        const outputs: ByteString = this.buildStateOutput(amount) + this.buildChangeOutput()\n        assert(this.ctx.hashOutputs == hash256(outputs), 'hashOutputs mismatch')\n    }\n}\n")),(0,o.kt)("h2",{id:"deploy"},"Deploy"),(0,o.kt)("p",null,"To deploy the smart contract, we define the following function:"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-ts"},"async function deploy(initialCount = 100n): Promise<string> {\n    const instance = new Counter(initialCount)\n    await instance.connect(getDefaultSigner())\n    const tx = await instance.deploy(1)\n    console.log(`Counter deployed: ${tx.id}, the count is: ${instance.count}`)\n    return tx.id\n}\n")),(0,o.kt)("p",null,"The function deploys the contract with a balance of 1 satoshi and returns the TXID of the deployed contract."),(0,o.kt)("h2",{id:"interact"},"Interact"),(0,o.kt)("p",null,"Next, we update our deployed smart contract by calling the following function:"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-ts"},"async function callIncrement(txId: string, atOutputIndex = 0): Promise<string> {\n    // Fetch tx via provider and reconstruct contract instance\n    const signer = getDefaultSigner()\n    const tx = await signer.connectedProvider.getTransaction(txId)\n    const instance = Counter.fromTx(tx, atOutputIndex)\n\n    await instance.connect(signer)\n\n    const nextInstance = instance.next()\n    nextInstance.count++\n\n    const { tx: callTx } = await instance.methods.increment({\n        next: {\n            instance: nextInstance,\n            balance: instance.balance,\n        },\n    } as MethodCallOptions<Counter>)\n    console.log(`Counter increment called: ${callTx.id}, the count now is: ${nextInstance.count}`)\n    return callTx.id\n}\n")),(0,o.kt)("p",null,"The function takes as parameters the TXID of the deployed smart contract to ",(0,o.kt)("a",{parentName:"p",href:"/how-to-deploy-and-call-a-contract/#create-a-smart-contract-instance-from-a-transaction"},"create an instance"),", along with the output index (which is usually 0). It uses the ",(0,o.kt)("a",{parentName:"p",href:"../reference/classes/DefaultProvider"},(0,o.kt)("inlineCode",{parentName:"a"},"DefaultProvider"))," to fetch the transaction data from the blockchain. Subsequently, it reconstructs the smart contract instance using the ",(0,o.kt)("a",{parentName:"p",href:"/how-to-write-a-contract/built-ins#fromtx"},(0,o.kt)("inlineCode",{parentName:"a"},"fromTx"))," function."),(0,o.kt)("p",null,"Let's encapsulate the entire process within a main function, designed to deploy the contract and increment its value five times:"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-ts"},"async function main() {\n    await compileContract()\n    let lastTxId = await deploy()\n    for (let i = 0; i < 5; ++i) {\n        lastTxId = await callIncrement(lastTxId)\n    }\n}\n\n(async () => {\n    await main()\n})()\n")),(0,o.kt)("p",null,"If we execute the code, we should get an output similar to the following:"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-ts"},"Counter deployed: 5cd1a8b6242f10dac80a63fa40adbcc5d61393936a8b380d113f102faee2f223, the count is: 100\nCounter increment called: a135cbac2960d8f062386f3aaa99e9f6f8a3c7c7184648c5729c8fc224c51c10, the count now is: 101\nCounter increment called: 61075b2538a08863ea9f8d6a3fc50d7789a8e370145eb2d258e0ae45db9366e4, the count now is: 102\nCounter increment called: 67427061927b00273960e643f81e914ccf8df8deb0b150c79e78615954d14f01, the count now is: 103\nCounter increment called: 3a0bc55b5ccdf45ed7d4a90df11e113ded083a942da9078963c6683caa27f836, the count now is: 104\nCounter increment called: 132cf69dc21d34d53725e7474c6f34a4098e59fc33d61e949b59a7a1f943693c, the count now is: 105\n")),(0,o.kt)("h2",{id:"conclusion"},"Conclusion"),(0,o.kt)("p",null,"Congratulations! You've now deployed AND interacted with a Bitcoin smart contract.\nYou can see a complete test example in our ",(0,o.kt)("a",{parentName:"p",href:"https://github.com/sCrypt-Inc/boilerplate/blob/master/tests/testnet/counterFromTx.ts"},"boilerplate repository"),"."))}d.isMDXComponent=!0}}]);