"use strict";(self.webpackChunkscrypt_docs=self.webpackChunkscrypt_docs||[]).push([[8929],{3905:(t,e,n)=>{n.d(e,{Zo:()=>u,kt:()=>h});var a=n(7294);function i(t,e,n){return e in t?Object.defineProperty(t,e,{value:n,enumerable:!0,configurable:!0,writable:!0}):t[e]=n,t}function o(t,e){var n=Object.keys(t);if(Object.getOwnPropertySymbols){var a=Object.getOwnPropertySymbols(t);e&&(a=a.filter((function(e){return Object.getOwnPropertyDescriptor(t,e).enumerable}))),n.push.apply(n,a)}return n}function r(t){for(var e=1;e<arguments.length;e++){var n=null!=arguments[e]?arguments[e]:{};e%2?o(Object(n),!0).forEach((function(e){i(t,e,n[e])})):Object.getOwnPropertyDescriptors?Object.defineProperties(t,Object.getOwnPropertyDescriptors(n)):o(Object(n)).forEach((function(e){Object.defineProperty(t,e,Object.getOwnPropertyDescriptor(n,e))}))}return t}function s(t,e){if(null==t)return{};var n,a,i=function(t,e){if(null==t)return{};var n,a,i={},o=Object.keys(t);for(a=0;a<o.length;a++)n=o[a],e.indexOf(n)>=0||(i[n]=t[n]);return i}(t,e);if(Object.getOwnPropertySymbols){var o=Object.getOwnPropertySymbols(t);for(a=0;a<o.length;a++)n=o[a],e.indexOf(n)>=0||Object.prototype.propertyIsEnumerable.call(t,n)&&(i[n]=t[n])}return i}var l=a.createContext({}),p=function(t){var e=a.useContext(l),n=e;return t&&(n="function"==typeof t?t(e):r(r({},e),t)),n},u=function(t){var e=p(t.components);return a.createElement(l.Provider,{value:e},t.children)},c={inlineCode:"code",wrapper:function(t){var e=t.children;return a.createElement(a.Fragment,{},e)}},d=a.forwardRef((function(t,e){var n=t.components,i=t.mdxType,o=t.originalType,l=t.parentName,u=s(t,["components","mdxType","originalType","parentName"]),d=p(n),h=i,m=d["".concat(l,".").concat(h)]||d[h]||c[h]||o;return n?a.createElement(m,r(r({ref:e},u),{},{components:n})):a.createElement(m,r({ref:e},u))}));function h(t,e){var n=arguments,i=e&&e.mdxType;if("string"==typeof t||i){var o=n.length,r=new Array(o);r[0]=d;var s={};for(var l in e)hasOwnProperty.call(e,l)&&(s[l]=e[l]);s.originalType=t,s.mdxType="string"==typeof t?t:i,r[1]=s;for(var p=2;p<o;p++)r[p]=n[p];return a.createElement.apply(null,r)}return a.createElement.apply(null,n)}d.displayName="MDXCreateElement"},7698:(t,e,n)=>{n.r(e),n.d(e,{assets:()=>l,contentTitle:()=>r,default:()=>c,frontMatter:()=>o,metadata:()=>s,toc:()=>p});var a=n(7462),i=(n(7294),n(3905));const o={sidebar_position:2},r="ScriptContext",s={unversionedId:"how-to-write-a-contract/scriptcontext",id:"how-to-write-a-contract/scriptcontext",title:"ScriptContext",description:"In the UTXO model, the context of validating a smart contract is the UTXO containing it and the transaction spending it, including its inputs and outputs. In the following example, when the second of input of transaction tx1 (2 inputs and 2 outputs) is spending the second output of tx0 (3 inputs and 3 outputs), the context for the smart contract in the latter output is roughly the UTXO and tx1 circled in red.",source:"@site/docs/how-to-write-a-contract/scriptcontext.md",sourceDirName:"how-to-write-a-contract",slug:"/how-to-write-a-contract/scriptcontext",permalink:"/how-to-write-a-contract/scriptcontext",draft:!1,tags:[],version:"current",sidebarPosition:2,frontMatter:{sidebar_position:2},sidebar:"tutorialSidebar",previous:{title:"How to Write a Contract",permalink:"/how-to-write-a-contract/"},next:{title:"Stateful Contracts",permalink:"/how-to-write-a-contract/stateful-contract"}},l={},p=[{value:"Access inputs and outputs",id:"access-inputs-and-outputs",level:3},{value:"SigHash Type",id:"sighash-type",level:3},{value:"Debugging",id:"debugging",level:3}],u={toc:p};function c(t){let{components:e,...o}=t;return(0,i.kt)("wrapper",(0,a.Z)({},u,o,{components:e,mdxType:"MDXLayout"}),(0,i.kt)("h1",{id:"scriptcontext"},"ScriptContext"),(0,i.kt)("p",null,"In the UTXO model, the context of validating a smart contract is the UTXO containing it and the transaction spending it, including its inputs and outputs. In the following example, when the second of input of transaction ",(0,i.kt)("inlineCode",{parentName:"p"},"tx1")," (2 inputs and 2 outputs) is spending the second output of ",(0,i.kt)("inlineCode",{parentName:"p"},"tx0")," (3 inputs and 3 outputs), the context for the smart contract in the latter output is roughly the UTXO and ",(0,i.kt)("inlineCode",{parentName:"p"},"tx1")," circled in red.\n",(0,i.kt)("img",{src:n(2968).Z,width:"1416",height:"524"})),(0,i.kt)("p",null,"The context only contains local information, different from account-based blockchains whose context consists of the global state of the entire blockchain (as in Ethereum). A single shared global state across all smart contracts kills scalability, since they all have to be sequentially processed due to potential race conditions."),(0,i.kt)("p",null,"This context is expressed in the ",(0,i.kt)("inlineCode",{parentName:"p"},"ScriptContext")," interface."),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-ts"},"export interface ScriptContext {\n  /** version number of [transaction]{@link https://wiki.bitcoinsv.io/index.php/Bitcoin_Transactions#General_format_of_a_Bitcoin_transaction} */\n  version: ByteString,\n  /** the specific UTXO spent by this transaction input */\n  utxo: UTXO,\n  /** double-SHA256 hash of the serialization of some/all input outpoints, see [hashPrevouts]{@link https://github.com/bitcoin-sv/bitcoin-sv/blob/master/doc/abc/replay-protected-sighash.md#hashprevouts} */\n  hashPrevouts: ByteString,\n  /** double-SHA256 hash of the serialization of some/all input sequence values, see [hashSequence]{@link https://github.com/bitcoin-sv/bitcoin-sv/blob/master/doc/abc/replay-protected-sighash.md#hashsequence} */\n  hashSequence: ByteString,\n  /** sequence number of [transaction input]{@link https://wiki.bitcoinsv.io/index.php/Bitcoin_Transactions#Format_of_a_Transaction_Input} */\n  sequence: bigint,\n  /** double-SHA256 hash of the serialization of some/all output amount with its locking script, see [hashOutputs]{@link https://github.com/bitcoin-sv/bitcoin-sv/blob/master/doc/abc/replay-protected-sighash.md#hashoutputs} */\n  hashOutputs: ByteString,\n  /** locktime of [transaction]{@link https://wiki.bitcoinsv.io/index.php/Bitcoin_Transactions#General_format_of_a_Bitcoin_transaction} */\n  locktime: bigint,\n  /** [SIGHASH flag]{@link https://wiki.bitcoinsv.io/index.php/SIGHASH_flags} used by this input */\n  sigHashType: SigHashType,\n}\n\nexport interface UTXO {\n  /** locking script */\n  script: ByteString,\n  /** amount in satoshis */\n  value: bigint,\n  /** outpoint referenced by this UTXO */\n  outpoint: Outpoint,\n}\n\nexport interface Outpoint {\n  /** txid of the transaction holding the output */\n  txid: ByteString,\n  /** index of the specific output */\n  outputIndex: bigint,\n}\n")),(0,i.kt)("p",null,"The table shows the meaning of each field of the ",(0,i.kt)("inlineCode",{parentName:"p"},"ScriptContext")," structure."),(0,i.kt)("table",null,(0,i.kt)("thead",{parentName:"table"},(0,i.kt)("tr",{parentName:"thead"},(0,i.kt)("th",{parentName:"tr",align:null},"Field"),(0,i.kt)("th",{parentName:"tr",align:null},"Description"))),(0,i.kt)("tbody",{parentName:"table"},(0,i.kt)("tr",{parentName:"tbody"},(0,i.kt)("td",{parentName:"tr",align:null},"version"),(0,i.kt)("td",{parentName:"tr",align:null},"version of the transaction")),(0,i.kt)("tr",{parentName:"tbody"},(0,i.kt)("td",{parentName:"tr",align:null},"utxo.value"),(0,i.kt)("td",{parentName:"tr",align:null},"value of the output spent by this input")),(0,i.kt)("tr",{parentName:"tbody"},(0,i.kt)("td",{parentName:"tr",align:null},"utxo.script"),(0,i.kt)("td",{parentName:"tr",align:null},"locking script of the UTXO")),(0,i.kt)("tr",{parentName:"tbody"},(0,i.kt)("td",{parentName:"tr",align:null},"utxo.outpoint.txid"),(0,i.kt)("td",{parentName:"tr",align:null},"txid of the transaction being spent")),(0,i.kt)("tr",{parentName:"tbody"},(0,i.kt)("td",{parentName:"tr",align:null},"utxo.outpoint.outputIndex"),(0,i.kt)("td",{parentName:"tr",align:null},"index of the UTXO in the outputs")),(0,i.kt)("tr",{parentName:"tbody"},(0,i.kt)("td",{parentName:"tr",align:null},"hashPrevouts"),(0,i.kt)("td",{parentName:"tr",align:null},"If the ",(0,i.kt)("inlineCode",{parentName:"td"},"ANYONECANPAY")," ",(0,i.kt)("a",{parentName:"td",href:"#sighash-type"},"SIGHASH type")," is not set, it's double SHA256 of the serialization of all input outpoints. Otherwise, it's a ",(0,i.kt)("inlineCode",{parentName:"td"},"unit256")," of ",(0,i.kt)("inlineCode",{parentName:"td"},"0x0000......0000"),".")),(0,i.kt)("tr",{parentName:"tbody"},(0,i.kt)("td",{parentName:"tr",align:null},"hashSequence"),(0,i.kt)("td",{parentName:"tr",align:null},"If none of the ",(0,i.kt)("inlineCode",{parentName:"td"},"ANYONECANPAY"),", ",(0,i.kt)("inlineCode",{parentName:"td"},"SINGLE"),", ",(0,i.kt)("inlineCode",{parentName:"td"},"NONE")," ",(0,i.kt)("a",{parentName:"td",href:"#sighash-type"},"SIGHASH type")," is set, it's double SHA256 of the serialization of sequence of all inputs. Otherwise, it's a ",(0,i.kt)("inlineCode",{parentName:"td"},"unit256")," of ",(0,i.kt)("inlineCode",{parentName:"td"},"0x0000......0000"),".")),(0,i.kt)("tr",{parentName:"tbody"},(0,i.kt)("td",{parentName:"tr",align:null},"sequence"),(0,i.kt)("td",{parentName:"tr",align:null},"sequence of the input")),(0,i.kt)("tr",{parentName:"tbody"},(0,i.kt)("td",{parentName:"tr",align:null},"hashOutputs"),(0,i.kt)("td",{parentName:"tr",align:null},"If the ",(0,i.kt)("a",{parentName:"td",href:"#sighash-type"},"SIGHASH type")," is neither ",(0,i.kt)("inlineCode",{parentName:"td"},"SINGLE")," nor ",(0,i.kt)("inlineCode",{parentName:"td"},"NONE"),", it's double SHA256 of the serialization of all outputs. If the ",(0,i.kt)("a",{parentName:"td",href:"#sighash-type"},"SIGHASH type")," is ",(0,i.kt)("inlineCode",{parentName:"td"},"SINGLE")," and the input index is smaller than the number of outputs, it's the double SHA256 of the output with the same index as the input. Otherwise, it's a ",(0,i.kt)("inlineCode",{parentName:"td"},"unit256")," of ",(0,i.kt)("inlineCode",{parentName:"td"},"0x0000......0000"),".")),(0,i.kt)("tr",{parentName:"tbody"},(0,i.kt)("td",{parentName:"tr",align:null},"locktime"),(0,i.kt)("td",{parentName:"tr",align:null},"locktime of the transaction")),(0,i.kt)("tr",{parentName:"tbody"},(0,i.kt)("td",{parentName:"tr",align:null},"sigHashType"),(0,i.kt)("td",{parentName:"tr",align:null},"sighash type of the signature")))),(0,i.kt)("p",null,"You can directly access the context through ",(0,i.kt)("inlineCode",{parentName:"p"},"this.ctx")," in any public ",(0,i.kt)("inlineCode",{parentName:"p"},"@method"),". It can be considered additional information a public method gets when called, besides its function parameters."),(0,i.kt)("p",null,"The example below accesses the ",(0,i.kt)("a",{parentName:"p",href:"https://learnmeabitcoin.com/technical/locktime"},"locktime")," of the spending transaction."),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-ts"},'class CheckLockTimeVerify extends SmartContract {\n  @prop()\n  readonly matureTime: bigint // Can be timestamp or block height.\n\n  constructor(matureTime: bigint) {\n    super(...arguments)\n    this.matureTime = matureTime\n  }\n\n  @method()\n  public timelock() {\n    assert(this.ctx.locktime >= this.matureTime, "locktime too low")\n  }\n}\n')),(0,i.kt)("admonition",{type:"note"},(0,i.kt)("p",{parentName:"admonition"},"Accessing ",(0,i.kt)("inlineCode",{parentName:"p"},"this.ctx")," in ",(0,i.kt)("strong",{parentName:"p"},"non-public")," methods is not allowed.")),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-ts"},"@method()\npropagateState(outputs: ByteString) : boolean {\n    return this.ctx.hashOutputs == hash256(outputs); // invalid\n}\n")),(0,i.kt)("h3",{id:"access-inputs-and-outputs"},"Access inputs and outputs"),(0,i.kt)("p",null,"The inputs and outputs of the spending transaction are not directly included in ",(0,i.kt)("inlineCode",{parentName:"p"},"ScriptContext"),", but their hashes/digests. To access them, we can build them first and validate they hash to the expected digest, which ensures they are actually from the spending transaction."),(0,i.kt)("p",null,"The following example ensures both Alice and Bob get 1000 satoshis from the contract."),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-ts"},"class DesignatedReceivers extends SmartContract {\n  @prop()\n  readonly alice: PubKeyHash\n\n  @prop()\n  readonly bob: PubKeyHash\n\n  constructor(alice: PubKeyHash, bob: PubKeyHash) {\n    super(...arguments)\n    this.alice = alice\n    this.bob = bob\n  }\n\n  @method()\n  public payout() {\n    const aliceOutput: ByteString = Utils.buildPublicKeyHashOutput(alice, 1000n)\n    const bobOutput: ByteString = Utils.buildPublicKeyHashOutput(bob, 1000n)\n    let outputs = aliceOutput + bobOutput\n\n    // require a change output\n    outputs += this.buildChangeOutput();\n\n    // ensure outputs are actually from the spending transaction as expected\n    assert(this.ctx.hashOutputs == hash256(outputs), 'hashOutputs mismatch')\n  }\n}\n")),(0,i.kt)("h3",{id:"sighash-type"},"SigHash Type"),(0,i.kt)("p",null,(0,i.kt)("a",{parentName:"p",href:"https://wiki.bitcoinsv.io/index.php/SIGHASH_flags"},"SigHash type")," decides which part of the spending transaction is included in ",(0,i.kt)("inlineCode",{parentName:"p"},"ScriptContext"),".\n",(0,i.kt)("img",{src:n(4296).Z,width:"1053",height:"745"}),"\nIt defaults to ",(0,i.kt)("inlineCode",{parentName:"p"},"SigHash.ALL"),", including all inputs and outputs. You can customize it by setting the argument of the ",(0,i.kt)("inlineCode",{parentName:"p"},"@method()")," decorator, e.g.,"),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-ts"},"@method(SigHash.ANYONECANPAY_SINGLE)\npublic increment() {\n  ...\n}\n")),(0,i.kt)("p",null,"There are a total of 6 sigHash types to choose from:"),(0,i.kt)("table",null,(0,i.kt)("thead",{parentName:"table"},(0,i.kt)("tr",{parentName:"thead"},(0,i.kt)("th",{parentName:"tr",align:null},"SigHash Type"),(0,i.kt)("th",{parentName:"tr",align:null},"Functional Meaning"))),(0,i.kt)("tbody",{parentName:"table"},(0,i.kt)("tr",{parentName:"tbody"},(0,i.kt)("td",{parentName:"tr",align:null},"ALL"),(0,i.kt)("td",{parentName:"tr",align:null},"Sign all inputs and outputs")),(0,i.kt)("tr",{parentName:"tbody"},(0,i.kt)("td",{parentName:"tr",align:null},"NONE"),(0,i.kt)("td",{parentName:"tr",align:null},"Sign all inputs and no output")),(0,i.kt)("tr",{parentName:"tbody"},(0,i.kt)("td",{parentName:"tr",align:null},"SINGLE"),(0,i.kt)("td",{parentName:"tr",align:null},"Sign all inputs and the output with the same index")),(0,i.kt)("tr",{parentName:"tbody"},(0,i.kt)("td",{parentName:"tr",align:null},"ANYONECANPAY_ALL"),(0,i.kt)("td",{parentName:"tr",align:null},"Sign its own input and all outputs")),(0,i.kt)("tr",{parentName:"tbody"},(0,i.kt)("td",{parentName:"tr",align:null},"ANYONECANPAY_NONE"),(0,i.kt)("td",{parentName:"tr",align:null},"Sign its own input and no output")),(0,i.kt)("tr",{parentName:"tbody"},(0,i.kt)("td",{parentName:"tr",align:null},"ANYONECANPAY_SINGLE"),(0,i.kt)("td",{parentName:"tr",align:null},"Sign its own input and the output with the same index")))),(0,i.kt)("h3",{id:"debugging"},"Debugging"),(0,i.kt)("p",null,"See ",(0,i.kt)("a",{parentName:"p",href:"/advanced/how-to-debug-scriptcontext"},"How to Debug ScriptContext Failure")))}c.isMDXComponent=!0},2968:(t,e,n)=>{n.d(e,{Z:()=>a});const a=n.p+"assets/images/scriptContext-a3ace5522bf62d82d20958735c13ddf4.jpg"},4296:(t,e,n)=>{n.d(e,{Z:()=>a});const a=n.p+"assets/images/sighashtypes-8b0d4314acae2a58b674bcdf32b2e17f.png"}}]);